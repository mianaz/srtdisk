---
title: 'Conversions: h5Seurat and AnnData'
output:
  rmarkdown::html_document:
    theme: cosmo
    toc: true
    toc_float: true
    code_folding: show
vignette: >
  %\VignetteIndexEntry{Conversions: h5Seurat and AnnData}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(reticulate)

# Configure Python - try conda base first, then system python
python_configured <- FALSE
tryCatch({
  if (file.exists("/opt/homebrew/Caskroom/miniconda/base/bin/python3")) {
    use_python("/opt/homebrew/Caskroom/miniconda/base/bin/python3", required = TRUE)
    python_configured <- TRUE
  }
}, error = function(e) NULL)

if (!python_configured) {
  tryCatch({
    use_python(Sys.which("python3"), required = FALSE)
  }, error = function(e) NULL)
}

# Check if scanpy is available for conditional evaluation
has_scanpy <- py_module_available("scanpy")
has_squidpy <- py_module_available("squidpy")

# Check if SeuratData is available
has_SeuratData <- requireNamespace("SeuratData", quietly = TRUE)

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  tidy = FALSE,
  out.width = "100%",
  dev = "png"
)
```

```{r cleanup, echo=FALSE, results='hide'}
outs <- c(
  "pbmc3k.h5Seurat",
  "pbmc3k.h5ad",
  "pbmc3k_final.h5ad",
  "pbmc3k_final.h5seurat",
  "stxBrain.h5Seurat",
  "stxBrain.h5ad",
  "stxBrain.h5seurat",
  "stxBrain_plot.png",
  "umap_plot.png",
  "crc_converted.h5seurat"
)
# Only remove files that exist to avoid warnings
existing_files <- outs[file.exists(outs)]
if (length(existing_files) > 0) {
  file.remove(existing_files)
}
```

This vignette showcases how to convert between `Seurat` objects and AnnData files via h5Seurat files. This allows interoperability between Seurat and [Scanpy](https://scanpy.readthedocs.io/).

```{r packages}
library(Seurat)
library(srtdisk)
```

## Converting from Seurat to AnnData via h5Seurat

To demonstrate conversion from a `Seurat` object to an AnnData file, we'll use the `pbmc3k.final` dataset from SeuratData - a processed PBMC dataset with clustering and UMAP.

```{r get_data, message=FALSE, warning=FALSE, eval = has_SeuratData}
library(SeuratData)

# Install pbmc3k if not already installed
if (!"pbmc3k.final" %in% rownames(InstalledData())) {
  InstallData("pbmc3k")
}

# Load the processed pbmc3k dataset
data("pbmc3k.final", package = "pbmc3k.SeuratData")
pbmc <- UpdateSeuratObject(pbmc3k.final)
pbmc
```

This is a fully processed Seurat object with clustering and dimensional reductions:

```{r plot_pbmc, eval = has_SeuratData}
DimPlot(pbmc, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
```

Converting the `Seurat` object to an AnnData file is a two-step process:

1. Save the `Seurat` object as an h5Seurat file using `SaveH5Seurat()`
2. Convert to AnnData using `Convert()`

```{r convert_seurat, eval = has_SeuratData}
SaveH5Seurat(pbmc, filename = "pbmc3k.h5Seurat", overwrite = TRUE)
Convert("pbmc3k.h5Seurat", dest = "h5ad", overwrite = TRUE)
```

We can view the AnnData file in Scanpy:

```{python load_adata, eval = has_scanpy && has_SeuratData}
import scanpy as sc
adata = sc.read_h5ad("pbmc3k.h5ad")
print(adata)
```

And visualize with cluster annotations:

```{python plot_adata, fig.width=8, fig.height=6, eval = has_scanpy && has_SeuratData}
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt

sc.pl.umap(adata, color='seurat_annotations', legend_loc='on data', legend_fontsize=8, show=False)
plt.tight_layout()
plt.savefig('umap_plot.png', dpi=100, bbox_inches='tight')
plt.close()
```

```{r show_plot, echo=FALSE, eval = has_scanpy && has_SeuratData, out.width="80%"}
if (file.exists("umap_plot.png")) {
  knitr::include_graphics("umap_plot.png")
}
```

## Converting from AnnData to Seurat via h5Seurat

To demonstrate conversion from AnnData to Seurat, we'll use a colorectal cancer sample from [CellxGene](https://cellxgene.cziscience.com) that's bundled with the package.

```{r get_h5ad}
# Copy bundled CRC h5ad file to working directory
h5ad_path <- system.file("testdata", "crc_sample.h5ad", package = "srtdisk")
if (file.exists(h5ad_path)) {
  file.copy(h5ad_path, "crc_sample.h5ad", overwrite = TRUE)
} else {
  # Download if not bundled (for development)
  download.file(
    "https://datasets.cellxgene.cziscience.com/91cf9a95-0b9a-4ece-b8eb-7b9e3409a0d3.h5ad",
    "crc_sample.h5ad",
    mode = "wb"
  )
}
```

View the h5ad file in Scanpy:

```{python view_crc, eval = has_scanpy}
import scanpy as sc
adata_crc = sc.read_h5ad("crc_sample.h5ad")
print(adata_crc)
print("\nobs columns:", list(adata_crc.obs.columns)[:10])
```

Convert to Seurat:

```{r convert_crc}
Convert("crc_sample.h5ad", dest = "h5seurat", overwrite = TRUE)
crc <- LoadH5Seurat("crc_sample.h5seurat")
crc
```

```{r plot_crc}
# Run UMAP if not present in converted object
if (!"umap" %in% Reductions(crc)) {
  crc <- NormalizeData(crc, verbose = FALSE)
  crc <- FindVariableFeatures(crc, verbose = FALSE)
  crc <- ScaleData(crc, verbose = FALSE)
  crc <- RunPCA(crc, verbose = FALSE)
  crc <- RunUMAP(crc, dims = 1:30, verbose = FALSE)
}
DimPlot(crc, reduction = "umap", pt.size = 0.5)
```

## Visium Spatial Data Conversion

For spatial transcriptomics data, we use the stxBrain dataset from SeuratData (Visium v2 format):

```{r get_stxBrain, eval = has_SeuratData}
library(SeuratData)

# Install stxBrain if not already installed
if (!"stxBrain" %in% rownames(InstalledData())) {
  InstallData("stxBrain")
}

# Load anterior1 section
brain <- UpdateSeuratObject(LoadData("stxBrain", type = "anterior1"))
brain <- NormalizeData(brain)
SpatialFeaturePlot(brain, features = "Hpca")
```

Convert to h5ad:

```{r convert_stxBrain, eval = has_SeuratData}
SaveH5Seurat(brain, filename = "stxBrain.h5Seurat", overwrite = TRUE)
Convert("stxBrain.h5Seurat", dest = "h5ad", overwrite = TRUE)
```

View in Python with Squidpy:

```{python load_stxBrain, fig.width=10, fig.height=8, eval = has_SeuratData && has_squidpy}
import squidpy as sq
import scanpy as sc
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt

adata_spatial = sc.read_h5ad("stxBrain.h5ad")
fig, ax = plt.subplots(figsize=(10, 8))
sq.pl.spatial_scatter(
    adata_spatial,
    color="Hpca",
    library_id="anterior1",
    img_res_key="lowres",
    size=1.5,
    ax=ax
)
plt.savefig('stxBrain_plot.png', dpi=100, bbox_inches='tight')
plt.close()
```

```{r show_stxBrain_plot, echo=FALSE, eval = has_SeuratData && has_squidpy, out.width="80%"}
if (file.exists("stxBrain_plot.png")) {
  knitr::include_graphics("stxBrain_plot.png")
}
```

## Multi-assay Conversion (CITE-seq)

For multi-modal data like CITE-seq, convert each assay separately. This example uses the `cbmc` dataset from SeuratData:

```{r cite_seq_conversion, eval = FALSE}
library(SeuratData)
InstallData("cbmc")
data("cbmc", package = "cbmc.SeuratData")

# RNA assay
SeuratToH5AD(cbmc, filename = "cbmc_rna.h5ad", assay = "RNA", overwrite = TRUE)

# ADT (protein) assay
SeuratToH5AD(cbmc, filename = "cbmc_adt.h5ad", assay = "ADT", overwrite = TRUE)
```

Each h5ad file can then be loaded separately in Python for analysis with scanpy.

## Spatial h5ad to Seurat (Beta)

Converting spatial h5ad files back to Seurat is supported but currently in beta:

```{r spatial_h5ad_to_seurat, eval = FALSE}
# Convert spatial h5ad back to Seurat
Convert("stxBrain.h5ad", dest = "h5seurat", overwrite = TRUE)
brain_back <- LoadH5Seurat("stxBrain.h5seurat")

# Verify spatial data was preserved
SpatialDimPlot(brain_back)
```

Note: Spatial coordinate systems may require manual verification after round-trip conversion.

## Python Environment Setup

For optimal interoperability, we recommend using a conda environment with scanpy:

```{r python_setup, eval = FALSE}
library(reticulate)

# Use existing scverse environment
use_condaenv("scverse", required = FALSE)

# Or create a new environment
# reticulate::conda_create("scverse")
# reticulate::conda_install("scverse", c("scanpy", "squidpy", "anndata"))

# Verify configuration
py_config()
```

```{r check_scanpy, eval = has_scanpy}
sc <- reticulate::import("scanpy")
cat("Scanpy version:", sc$`__version__`, "\n")
```

## Metadata Preservation

srtdisk preserves cell metadata during conversion:

- **Categorical data**: Cell types, clusters, batch labels
- **Numerical data**: QC metrics like nCount_RNA, percent.mt
- **Factor ordering**: Level order for visualization

### Cluster Column Mapping

| Seurat | AnnData/scanpy |
|--------|----------------|
| `seurat_clusters` | `leiden` or `louvain` |
| `orig.ident` | `batch` |
| `nCount_RNA` | `n_counts` |
| `nFeature_RNA` | `n_genes` |

## Session Info

```{r sessionInfo}
sessionInfo()
```
